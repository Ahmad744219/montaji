<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³Ù†Ø§Ø¯ - Ù‚Ø§Ù„Ø¨ Ù…ÙˆÙ†ØªØ§Ú˜</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        .editor-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .editor-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4a6491;
        }

        /* A4 Paper Styling */
        .a4-paper {
            width: 21cm;
            min-height: 29.7cm;
            background: white;
            margin: 20px auto;
            padding-left: 1.27cm;
            padding-right: 1.27cm; /* Narrow left-right padding like Word */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .editable-area {
            min-height: 18cm;
            line-height: 1.8;
            font-size: 14px;
            outline: none;
            direction: rtl;
            text-align: right;
            font-family: Arial, sans-serif;
        }

        .placeholder {
            color: #000000;
            font-weight: normal;
            margin: 0 5px;
            cursor: pointer;
            display: inline-block;
            font-family: Arial, sans-serif;
            direction: ltr;
            text-align: left;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .formatting-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .format-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 40px;
            transition: all 0.2s;
        }

        .format-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .format-btn.active {
            background: #4a6491;
            color: white;
            border-color: #4a6491;
        }

        .font-select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        .font-size-select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            width: 70px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0 8px;
            border-right: 1px solid #dee2e6;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: Arial, sans-serif;
        }

        .primary-btn {
            background: #4a6491;
            color: white;
        }

        .primary-btn:hover {
            background: #3a5378;
            transform: translateY(-2px);
        }

        .secondary-btn {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .secondary-btn:hover {
            background: #e9ecef;
        }

        .success-btn {
            background: #28a745;
            color: white;
        }

        .success-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .warning-btn {
            background: #ffc107;
            color: #212529;
        }

        .warning-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .file-label:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .data-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }

        .data-table th {
            background: #4a6491;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            font-family: Arial, sans-serif;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6491;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4a6491, #3498db);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
            font-family: Arial, sans-serif;
        }

        .batch-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
            font-family: Arial, sans-serif;
        }

        .batch-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: Arial, sans-serif;
        }

        .template-management {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .template-management h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .template-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .template-item {
            padding: 8px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-item:hover {
            background: #e9ecef;
        }

        .template-name {
            font-weight: 500;
        }

        .template-date {
            font-size: 12px;
            color: #6c757d;
        }

        .delete-template {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .delete-template:hover {
            background: #f8d7da;
        }

        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4a6491;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            display: none;
            font-family: Arial, sans-serif;
        }

        /* Arabic/RTL specific styling */
        .arabic-text {
            font-family: Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }
        
        .fixed-top-right {
            position: absolute;
            top: 30px;
            right: 25px;
            direction: rtl;
            text-align: right;
            font-family: Arial, sans-serif;
            z-index: 100;
            background: transparent;
            border: none;
            outline: none;
            width: 280px;
            min-height: 80px;
            resize: none;
            line-height: 1.5;
            font-size: 18px;
            font-weight: bold;
            color: #000;
        }

        .fixed-top-right:focus {
            background: rgba(255, 255, 255, 0.8);
            border: 1px dashed #4a6491;
        }
        
        /* Page number styling - NEW ADDITION */
        .page-number {
            position: absolute;
            bottom: 40px; /* Position above the footer image */
            left: 30px; /* Bottom left corner */
            font-size: 18px;
            font-family: Arial, sans-serif;
            color: #000;
            z-index: 10; /* Above the footer image */
            background: transparent;
            padding: 2px 6px;
            border-radius: 3px;
            pointer-events: none; /* Don't interfere with other elements */
            font-weight: normal;
            text-align: left;
            direction: ltr;
            white-space: nowrap;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .a4-paper, .a4-paper * {
                visibility: visible;
            }
            .a4-paper {
                position: absolute;
                left: 0;
                top: 0;
                width: 21cm;
                box-shadow: none;
                margin: 0;
                padding-left: 1.27cm;
                padding-right: 1.27cm;
            }
            .page-number {
                position: absolute;
                bottom: 40px;
                left: 30px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Menu with three buttons that redirect -->
        <div class="top-menu" style="background: linear-gradient(135deg, #2c3e50, #4a6491); padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; display: flex; gap: 15px; justify-content: flex-end; box-shadow: 0 2px 4px rgba(0,0,0,0.1); direction: rtl;">
            <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: Arial, sans-serif;" onclick="location.href='./index.html'">Ù…Ú©ØªÙˆØ¨ Ø¬ÙØªÛŒ</button>
            <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: Arial, sans-serif;" onclick="location.href='./big.html'">Ø³Ø§Ø®Øª Ù…Ú©ØªÙˆØ¨ ØªÚ©ÛŒ</button>
            <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: Arial, sans-serif;" onclick="location.href='./jadval.html'">Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„</button>
        </div>
        <header>
            <h1>ğŸ“„ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³Ù†Ø§Ø¯</h1>
            <p>Ù‚Ø§Ù„Ø¨ Ù…ÙˆÙ†ØªØ§Ú˜ - ØªÙˆÙ„ÛŒØ¯ PDF Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù†ØŒ Ø´Ø§Ø³ÛŒ Ùˆ ÙˆÙ„Ø§ÛŒØª</p>
        </header>

        <div class="app-container">
            <div class="editor-section">
                <h2>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ø³Ù†Ø¯ (ÙØ±Ù…Øª A4)</h2>
                
                <div class="controls">
                    <button class="secondary-btn" onclick="insertPlaceholder('engine')">
                        ğŸ”§ Ø¯Ø±Ø¬ Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù†
                    </button>
                    <button class="secondary-btn" onclick="insertPlaceholder('chassis')">
                        ğŸš— Ø¯Ø±Ø¬ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø§Ø³ÛŒ
                    </button>
                    <button class="secondary-btn" onclick="insertPlaceholder('province')">
                        ğŸ—ºï¸ Ø¯Ø±Ø¬ ÙˆÙ„Ø§ÛŒØª
                    </button>
                    <button class="secondary-btn" onclick="clearEditor()">
                        ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø±
                    </button>
                </div>

                <div class="formatting-toolbar">
                    <div class="toolbar-group">
                        <select id="fontFamily" class="font-select" onchange="formatText('fontName', this.value)">
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Verdana">Verdana</option>
                        </select>
                    </div>
                    
                    <div class="toolbar-group">
                        <select id="fontSize" class="font-size-select" onchange="formatText('fontSize', this.value)">
                            <option value="1">8pt</option>
                            <option value="2">10pt</option>
                            <option value="3" selected>12pt</option>
                            <option value="4">14pt</option>
                            <option value="5">18pt</option>
                            <option value="6">24pt</option>
                            <option value="7">36pt</option>
                        </select>
                    </div>
                    
                    <div class="toolbar-group">
                        <button class="format-btn" onclick="toggleFormat('bold')" title="Ù¾Ø±Ø±Ù†Ú¯">
                            <b>B</b>
                        </button>
                        <button class="format-btn" onclick="toggleFormat('italic')" title="Ú©Ø¬">
                            <i>I</i>
                        </button>
                        <button class="format-btn" onclick="toggleFormat('underline')" title="Ø²ÛŒØ±Ø®Ø·">
                            <u>U</u>
                        </button>
                    </div>
                    
                    <div class="toolbar-group">
                        <button class="format-btn" onclick="formatText('justifyLeft')" title="Ú†Ù¾â€ŒÚ†ÛŒÙ†">
                            â‰¡
                        </button>
                        <button class="format-btn" onclick="formatText('justifyCenter')" title="ÙˆØ³Ø·â€ŒÚ†ÛŒÙ†">
                            â‰¡
                        </button>
                        <button class="format-btn" onclick="formatText('justifyRight')" title="Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ†">
                            â‰¡
                        </button>
                        <button class="format-btn" onclick="formatText('justifyFull')" title="Ù‡Ù…â€ŒØªØ±Ø§Ø²">
                            â‰¡
                        </button>
                    </div>
                    
                    <div class="toolbar-group">
                        <button class="format-btn" onclick="formatText('removeFormat')" title="Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø§Ù„Ø¨">
                            ğŸ—‘ï¸
                        </button>
                        <button class="format-btn" onclick="formatText('undo')" title="ÙˆØ§Ú¯Ø±Ø¯Ø§Ù†ÛŒ">
                            â†©ï¸
                        </button>
                        <button class="format-btn" onclick="formatText('redo')" title="Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ">
                            â†ªï¸
                        </button>
                    </div>
                </div>

                <div class="template-management">
                    <h3>ğŸ“ Ù…Ø¯ÛŒØ±ÛŒØª Ù‚Ø§Ù„Ø¨</h3>
                    <div class="template-buttons">
                        <button class="success-btn" onclick="saveTemplate()">
                            ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù‚Ø§Ù„Ø¨ ÙØ¹Ù„ÛŒ
                        </button>
                        <button class="warning-btn" onclick="loadDefaultTemplate()">
                            ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                        </button>
                        <button class="secondary-btn" onclick="exportTemplate()">
                            ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ù‚Ø§Ù„Ø¨
                        </button>
                        <button class="secondary-btn" onclick="importTemplate()">
                            ğŸ“¥ ÙˆØ±ÙˆØ¯ÛŒ Ù‚Ø§Ù„Ø¨
                        </button>
                    </div>
                    <div id="templateList" class="template-list">
                        <!-- Templates will be loaded here -->
                    </div>
                    <input type="file" id="templateFile" accept=".json" style="display: none" onchange="handleTemplateImport(event)">
                </div>

                <div class="a4-paper">
                    <div class="header-image" style="text-align: center; height: auto; margin: 0; padding: 0;">
                       <img src="./header.JPG" style="max-width: 350px; height: auto;" alt="ØªØµÙˆÛŒØ± Ø³Ø±Ø¨Ø±Ú¯">
                    </div>
                    <textarea 
                        id="fixedText" 
                        class="fixed-top-right arabic-text" 
                        placeholder="Ù…ØªÙ† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ (Ø­Ø¯Ø§Ú©Ø«Ø± Û³ Ø®Ø·)"
                        rows="3"
                        maxlength="200"
                    ></textarea>
                    
                    <div 
                        id="editor" 
                        class="editable-area arabic-text" 
                        contenteditable="true"
                        oninput="updateFormatting()"
                        onkeyup="updateFormatting()"
                        onclick="updateFormatting()"
                    >
                    </div>
                    
                    <div style="position: absolute; bottom: 30px; width: 85%; display: flex; justify-content: center;">
                        <img src="./footer.JPG" style="max-width: 90%; height: auto;" alt="ØªØµÙˆÛŒØ± Ù¾Ø§ÙˆØ±Ù‚ÛŒ">
                    </div>
                </div>
            </div>

            <div class="data-section">
                <h2>ğŸ“Š Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h2>
                
                <div class="controls">
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" class="file-input">
                    <label for="excelFile" class="file-label">
                        ğŸ“ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„
                    </label>
                    <button class="primary-btn" onclick="generatePDFs()">
                        ğŸ“„ ØªÙˆÙ„ÛŒØ¯ PDF
                    </button>
                </div>

                <div class="batch-controls">
                    <label>Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¯Ø³ØªÙ‡:</label>
                    <input type="number" id="batchSize" class="batch-input" value="25" min="10" max="100">
                    <span style="color: #666; font-size: 14px;">Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Ù‡Ø± Ø¯Ø³ØªÙ‡</span>
                </div>

                <div id="progressContainer" style="display: none;">
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    <div id="progressText" class="progress-text">0%</div>
                </div>

                <div id="status" class="status"></div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ ØªÙˆÙ„ÛŒØ¯ PDF...</p>
                </div>

                <div id="dataPreview">
                    <p style="color: #6c757d; margin-top: 20px;">
                        Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯. Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ "Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù†"ØŒ "Ø´Ù…Ø§Ø±Ù‡ Ø´Ø§Ø³ÛŒ" Ùˆ "ÙˆÙ„Ø§ÛŒØª" Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
                    </p>
                </div>
            </div>
        </div>

        <div class="footer">
            
        </div>

        <div id="installBtn" class="install-btn" onclick="installPWA()">
            ğŸ“± Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡
        </div>
    </div>

    <!-- Include required libraries -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // Global variables
        let excelData = [];
        let deferredPrompt;
        const STORAGE_KEY = 'document_templates';

        // Default template content
        const DEFAULT_TEMPLATE = {
    name: 'Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ´â€ŒÙØ±Ø¶',
    content: `Ù…ÙˆØ¶ÙˆØ¹:- Ø§Ø³Ù†Ø§Ø¯ Ù…ÙˆØªØªØ§Ú˜ Ùˆ Ø¨Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ

Ø¨Ù‡ Ø±ÛŒØ§Ø³Øª Ù…Ø­ØªØ±Ù… Ú¯Ù…Ø±Ú© Ú©Ø§Ø¨Ù„!

Ø§Ù„Ø³Ù„Ø§Ù… Ùˆ Ø¹Ù„ÛŒÚ©Ù… Ùˆ Ø±Ø­Ù…ØªÙ‡ Ø§Ù„Ù„Ù‡ Ùˆ Ø¨Ø±Ú©Ø§ØªÙ‡

Ø´Ø±Ú©Øª ØªÙˆÙ„ÛŒØ¯ÛŒ Ùˆ Ù¾Ø±ÙˆØ³Ø³ Ø¨Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ ÙˆÛŒÙ¾Ø± Ù…ÙˆØªØ±Ø³Ø§ÛŒÚ©Ù„Ø² ØªØ±ÛŒØ¯ÛŒÙ†Ú¯ Ø§Ù„ Ø§Ù„ Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯Ù‡ Ø¬ÙˆØ§Ø² Ù†Ù…Ø¨Ø± (89259) ÙˆTIN(9022292586) Ù‚Ø±Ø§Ø± ØªÛŒ ÛŒÚ© Ù†Ù…Ø¨Ø± (87423) Ù…ÙˆØ±Ø® (1404/10/14) Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ (126) Ø¹Ø±Ø§Ø¯Ù‡ Ù…ÙˆØªØ± Ø³Ø§ÛŒÚ©Ù„ Ø±Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ù¾Ø±Ø²Ù‡ ØºØ±Ø¶ Ù…ÙˆÙ†ØªØ§Ú˜ Ùˆ Ø¨Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ø´ÙˆØ± Ù†Ù…ÙˆØ¯Ù‡. Ú©Ù‡ Ø¨Ø¹Ø¯Ø§ Ù‚Ø±Ø§Ø± (I) Ù†Ù…Ø¨Ø± (89591) Ù…ÙˆØ±Ø® (1404/10/15) Ø¨Ù‡ Ø´Ú©Ù„ Ù¾Ø±Ø²Ù‡ Ø¯Ø± Ú¯Ù…Ø±Ú© Ù‡Ø±Ø§Øª Ø·ÛŒ Ù…Ø±Ø§Ø­Ù„ Ù…Ø­ØµÙˆÙ„ Ù†Ù…ÙˆØ¯Ù‡ Ùˆ Ø°Ø±ÛŒØ¹Ù‡ (I) Ù†Ù…Ø¨Ø± (90846) Ù…ÙˆØ±Ø® (1404/10/20) Ø¨Ø¹Ø¯ Ø§Ø² ØªÚ©Ù…ÛŒÙ„ Ù¾Ø±ÙˆØ³Ø³ Ù†Ù‡Ø§ÛŒÛŒ Ù…ÙˆÙ†ØªØ§Ú˜ Ùˆ Ø¨Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù† ØªÙˆØ³Ø· Ø´Ø±Ú©Øª Ù…Ø­ØªØ±Ù… ØºØ±Ø¶ Ø§Ø¬Ø±Ø§Ø¢Øª ØªØ±Ø§ÙÛŒÚ©ÛŒ Ø¨Ø§ Ù…Ø´Ø®ØµØ§Øª Ø°ÛŒÙ„ Ú†Ù†ÛŒÙ† Ø§Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ¯Ù‡:Ù…ÙˆØªØ± Ø³Ø§ÛŒÚ©Ù„ (Ø¨Ø¬Ø§Ø¬) Ù…Ø¯Ù„ (2026) Ø¨Ù‡ Ø±Ù†Ú¯ (          ) Ø³ÛŒ Ø³ÛŒ (150) Ù…ÙˆÙ†ØªØ§Ú˜ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù† Ø¯Ùˆ Ú†Ø±Ø®Ù‡ ÛŒÚ© Ø³Ù„Ù†Ø¯Ø± Ø¯Ùˆ Ù†ÙØ±ÛŒ Ø¯Ø§Ø±Ø§ÛŒ Ø§Ù†Ø¬ÛŒÙ† Ùˆ Ø´Ø§Ø³ÛŒ Ù†Ù…Ø¨Ø± Ø°ÛŒÙ„:



                                                      <span class="placeholder" data-type="engine">[ENGINE_NUMBER]</span>

                                             ______________________



                                                <span class="placeholder" data-type="chassis">[CHASSIS_NUMBER]</span>



Ù‚ÛŒÙ…Øª Ù¾Ø±Ø²Ù‡ Ø¨Ù‡ Ø¯Ø§Ù„Ø± : (196)

Ù…Ø­ØµÙˆÙ„ Ùˆ Ø¹ÙˆØ§Ø±Ø¶ Ù¾Ø±Ø²Ù‡ Ø¨Ù‡ Ø§ÙØºØ§Ù†ÛŒ : (2552)


Ù…Ø±Ø§ØªØ¨ ÙÙˆÙ‚Ø§ Ø§Ø±Ù‚Ø§Ù… Ú¯Ø±Ø¯ÛŒØ¯Ù‡ Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø¹Ø±Ø§Ø¯Ù‡ ÙÙˆÙ‚ Ø¨Ù‡ Ø´Ú©Ù„ Ù¾Ø±Ø²Ù‡ Ø·ÛŒ Ù…Ø±Ø§Ø­Ù„ Ú¯Ø±Ø¯ÛŒØ¯Ù‡ Ø¨Ø§ Ù…Ù„Ø§Ø­Ø¸Ù‡ Ø¢Ù† Ø¯Ø± Ø±ÙˆØ´Ù†ÛŒ Ù‚Ø§Ù†ÙˆÙ† Ø·ÙˆØ±ÛŒÚ©Ù‡ Ù„Ø§Ø²Ù… Ø¯Ø§Ù†Ù†Ø¯ Ø§Ø¬Ø±Ø§Ø¢Øª Ø®ÙˆØ§Ù‡Ù†Ø¯ ÙØ±Ù…ÙˆØ¯`,
    fixedText: '',
    createdAt: new Date().toISOString(),
    isDefault: true
};

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if browser supports service workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Registration Failed:', err));
            }

            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'block';
            });

            // Setup file upload listener
            document.getElementById('excelFile').addEventListener('change', handleExcel);
            
            // Load templates and set initial content
            loadTemplates();
            
            // Initialize formatting buttons
            updateFormatting();
        });

        // Template Management Functions
        function getTemplates() {
            const templates = localStorage.getItem(STORAGE_KEY);
            return templates ? JSON.parse(templates) : [DEFAULT_TEMPLATE];
        }

        function saveTemplates(templates) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(templates));
        }

        function loadTemplates() {
            const templates = getTemplates();
            renderTemplateList(templates);
            
            // Load the first template (usually default)
            if (templates.length > 0) {
                loadTemplate(templates[0]);
            }
        }

        function renderTemplateList(templates) {
            const templateList = document.getElementById('templateList');
            templateList.innerHTML = '';
            
            templates.forEach((template, index) => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                templateItem.innerHTML = `
                    <div>
                        <div class="template-name">${template.name}</div>
                        <div class="template-date">${new Date(template.createdAt).toLocaleDateString('fa-IR')}</div>
                    </div>
                    ${template.isDefault ? '' : '<button class="delete-template" onclick="deleteTemplate(' + index + ')">ğŸ—‘ï¸</button>'}
                `;
                
                templateItem.onclick = () => loadTemplate(template);
                templateList.appendChild(templateItem);
            });
        }

        function saveTemplate() {
            const content = document.getElementById('editor').innerHTML;
            const fixedText = document.getElementById('fixedText').value;
            const templateName = prompt('Ù†Ø§Ù… Ø§ÛŒÙ† Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', 'Ù‚Ø§Ù„Ø¨ Ù…Ù† ' + new Date().toLocaleDateString('fa-IR'));
            
            if (!templateName) return;
            
            const templates = getTemplates();
            const newTemplate = {
                name: templateName,
                content: content,
                fixedText: fixedText || '',
                createdAt: new Date().toISOString(),
                isDefault: false
            };
            
            // Remove existing template with same name (if any)
            const existingIndex = templates.findIndex(t => t.name === templateName && !t.isDefault);
            if (existingIndex !== -1) {
                templates[existingIndex] = newTemplate;
            } else {
                templates.push(newTemplate);
            }
            
            saveTemplates(templates);
            renderTemplateList(templates);
            showStatus('âœ… Ù‚Ø§Ù„Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!', 'success');
        }

        function loadTemplate(template) {
            document.getElementById('editor').innerHTML = template.content;
            document.getElementById('fixedText').value = template.fixedText || '';
            updateFormatting();
            showStatus(`âœ… Ù‚Ø§Ù„Ø¨ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯: ${template.name}`, 'success');
        }

        function loadDefaultTemplate() {
            if (confirm('Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯ØŸ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.')) {
                loadTemplate(DEFAULT_TEMPLATE);
            }
        }

        function deleteTemplate(index) {
            const templates = getTemplates();
            if (templates[index].isDefault) {
                showStatus('âŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯', 'error');
                return;
            }
            
            if (confirm('Ø§ÛŒÙ† Ù‚Ø§Ù„Ø¨ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
                templates.splice(index, 1);
                saveTemplates(templates);
                renderTemplateList(templates);
                showStatus('âœ… Ù‚Ø§Ù„Ø¨ Ø­Ø°Ù Ø´Ø¯', 'success');
            }
        }

        function exportTemplate() {
            const content = document.getElementById('editor').innerHTML;
            const fixedText = document.getElementById('fixedText').value;
            const templateName = prompt('Ù†Ø§Ù… Ù‚Ø§Ù„Ø¨ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ:', 'Ù‚Ø§Ù„Ø¨ Ø®Ø±ÙˆØ¬ÛŒ ' + new Date().toLocaleDateString('fa-IR'));
            
            if (!templateName) return;
            
            const template = {
                name: templateName,
                content: content,
                fixedText: fixedText || '',
                createdAt: new Date().toISOString(),
                isDefault: false
            };
            
            const dataStr = JSON.stringify(template, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = templateName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showStatus('âœ… Ù‚Ø§Ù„Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯!', 'success');
        }

        function importTemplate() {
            document.getElementById('templateFile').click();
        }

        function handleTemplateImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const template = JSON.parse(e.target.result);
                    
                    // Validate template structure
                    if (!template.name || !template.content) {
                        throw new Error('Invalid template file');
                    }
                    
                    // Add to templates
                    const templates = getTemplates();
                    template.createdAt = new Date().toISOString();
                    template.isDefault = false;
                    templates.push(template);
                    saveTemplates(templates);
                    
                    // Load the imported template
                    loadTemplate(template);
                    renderTemplateList(templates);
                    
                    showStatus('âœ… Ù‚Ø§Ù„Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯!', 'success');
                } catch (error) {
                    showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù‚Ø§Ù„Ø¨: ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Formatting functions
        function formatText(command, value = null) {
            const editor = document.getElementById('editor');
            editor.focus();
            
            try {
                if (command === 'undo' || command === 'redo') {
                    document.execCommand(command, false, null);
                } else if (value) {
                    document.execCommand(command, false, value);
                } else {
                    document.execCommand(command, false, null);
                }
            } catch (e) {
                console.log('Formatting error:', e);
            }
            
            updateFormatting();
        }

        function toggleFormat(command) {
            formatText(command);
            
            // Toggle active state for the button
            const buttons = document.querySelectorAll('.format-btn');
            buttons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(command)) {
                    btn.classList.toggle('active');
                }
            });
        }

        function updateFormatting() {
            const editor = document.getElementById('editor');
            const selection = window.getSelection();
            
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;
            const element = container.nodeType === 3 ? container.parentElement : container;
            
            // Update font family dropdown
            const computedStyle = window.getComputedStyle(element);
            const fontFamily = computedStyle.fontFamily;
            const fontFamilySelect = document.getElementById('fontFamily');
            
            if (fontFamily.includes('Arial')) fontFamilySelect.value = 'Arial';
            else if (fontFamily.includes('Times')) fontFamilySelect.value = 'Times New Roman';
            else if (fontFamily.includes('Courier')) fontFamilySelect.value = 'Courier New';
            else if (fontFamily.includes('Georgia')) fontFamilySelect.value = 'Georgia';
            else if (fontFamily.includes('Verdana')) fontFamilySelect.value = 'Verdana';
            
            // Update font size dropdown
            const fontSize = computedStyle.fontSize;
            const fontSizeSelect = document.getElementById('fontSize');
            
            if (fontSize === '8px') fontSizeSelect.value = '1';
            else if (fontSize === '10px') fontSizeSelect.value = '2';
            else if (fontSize === '12px') fontSizeSelect.value = '3';
            else if (fontSize === '14px') fontSizeSelect.value = '4';
            else if (fontSize === '18px') fontSizeSelect.value = '5';
            else if (fontSize === '24px') fontSizeSelect.value = '6';
            else if (fontSize === '36px') fontSizeSelect.value = '7';
            
            // Update bold/italic/underline buttons
            const formatButtons = document.querySelectorAll('.format-btn');
            formatButtons.forEach(btn => {
                const text = btn.textContent;
                if (text.includes('B')) {
                    btn.classList.toggle('active', document.queryCommandState('bold'));
                } else if (text.includes('I')) {
                    btn.classList.toggle('active', document.queryCommandState('italic'));
                } else if (text.includes('U')) {
                    btn.classList.toggle('active', document.queryCommandState('underline'));
                }
            });
        }

        // Excel handling function with Persian column name support
        function handleExcel(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = (evt) => {
                try {
                    // Check if it's already a binary string
                    let binaryStr;
                    if (typeof evt.target.result === 'string') {
                        binaryStr = evt.target.result;
                    } else {
                        // Convert array buffer to binary string
                        const bytes = new Uint8Array(evt.target.result);
                        binaryStr = bytes.reduce((acc, byte) => acc + String.fromCharCode(byte), '');
                    }

                    const workbook = XLSX.read(binaryStr, { type: "binary" });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];

                    // Read raw rows
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    // Find header row (contains Engine No, Chassis No, and Province)
                    const headerRowIndex = rows.findIndex(row =>
                        Array.isArray(row) &&
                        row.some(cell => cell && typeof cell === 'string' && 
                             (cell.toLowerCase().includes("engine") || 
                              cell.includes("Ø§Ù†Ø¬Ù†") || 
                              cell.includes("Ø§Ù†Ø¬ÛŒÙ†") ||
                              cell.includes("Ø§ÛŒÙ†Ø¬ÛŒÙ†") ||
                              cell === "Engine No"))
                    );

                    if (headerRowIndex === -1) {
                        showStatus('âŒ Ø³ØªÙˆÙ† Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯', 'error');
                        return;
                    }

                    const headers = rows[headerRowIndex];
                    
                    // Find indices for engine, chassis, and province with flexible matching
                    let engineIndex = -1;
                    let chassisIndex = -1;
                    let provinceIndex = -1;
                    
                    // List of possible Persian/English column names
                    const engineKeywords = ['engine', 'motornr', 'motor no', 'Ø§Ù†Ø¬Ù†', 'Ø§Ù†Ø¬ÛŒÙ†', 'Ø§ÛŒÙ†Ø¬ÛŒÙ†', 'Ù…ÙˆØªÙˆØ±'];
                    const chassisKeywords = ['chassis', 'rahmen', 'frame', 'Ø´Ø§Ø³ÛŒ', 'Ú†Ø§Ø³ÛŒ', 'Ú†Ø³Ø³'];
                    const provinceKeywords = ['province', 'ÙˆÙ„Ø§ÛŒØª', 'Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª', 'Ø§Ø³ØªØ§Ù†', 'ØµÙˆØ¨Û'];
                    
                    for (let i = 0; i < headers.length; i++) {
                        const cell = headers[i];
                        if (cell && typeof cell === 'string') {
                            const lowerCell = cell.toLowerCase().trim();
                            const cellValue = cell.trim();
                            
                            // Check for engine
                            if (engineIndex === -1) {
                                const isEngine = engineKeywords.some(keyword => 
                                    lowerCell.includes(keyword.toLowerCase()) || 
                                    cellValue.includes(keyword)
                                );
                                if (isEngine) {
                                    engineIndex = i;
                                    continue;
                                }
                            }
                            
                            // Check for chassis
                            if (chassisIndex === -1) {
                                const isChassis = chassisKeywords.some(keyword => 
                                    lowerCell.includes(keyword.toLowerCase()) || 
                                    cellValue.includes(keyword)
                                );
                                if (isChassis) {
                                    chassisIndex = i;
                                    continue;
                                }
                            }
                            
                            // Check for province
                            if (provinceIndex === -1) {
                                const isProvince = provinceKeywords.some(keyword => 
                                    lowerCell.includes(keyword.toLowerCase()) || 
                                    cellValue.includes(keyword)
                                );
                                if (isProvince) {
                                    provinceIndex = i;
                                    continue;
                                }
                            }
                        }
                    }

                    // Log found indices for debugging
                    console.log('Found indices:', { engineIndex, chassisIndex, provinceIndex });
                    console.log('Headers:', headers);

                    if (engineIndex === -1 || chassisIndex === -1) {
                        showStatus('âŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù† ÛŒØ§ Ø´Ø§Ø³ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù†Ø¯', 'error');
                        return;
                    }

                    // Process data rows
                    excelData = rows
                        .slice(headerRowIndex + 1)
                        .filter(r => r && (r[engineIndex] || r[chassisIndex]))
                        .map(r => ({
                            engineNo: String(r[engineIndex] || '').trim(),
                            chassisNo: String(r[chassisIndex] || '').trim(),
                            province: provinceIndex !== -1 ? String(r[provinceIndex] || '').trim() : '',
                            rowData: r
                        }));

                    if (!excelData.length) {
                        showStatus('âŒ Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
                        return;
                    }

                    // Display preview
                    displayDataPreview(excelData);
                    
                    const provinceInfo = provinceIndex !== -1 ? '(Ø¨Ø§ Ø¯Ø§Ø¯Ù‡ ÙˆÙ„Ø§ÛŒØª)' : '(Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡ ÙˆÙ„Ø§ÛŒØª)';
                    showStatus(`âœ… ØªØ¹Ø¯Ø§Ø¯ ${excelData.length} Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ ${provinceInfo}`, 'success');
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„. Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯.', 'error');
                }
            };

            // Use readAsBinaryString for your original function
            try {
                reader.readAsBinaryString(file);
            } catch (error) {
                // Fallback to array buffer
                reader.readAsArrayBuffer(file);
            }
        }

        // Display data preview
        function displayDataPreview(data) {
            const previewDiv = document.getElementById('dataPreview');
            
            if (data.length === 0) {
                previewDiv.innerHTML = '<p style="color: #dc3545;">Ø¯Ø§Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>';
                return;
            }
            
            // Check if we have province data
            const hasProvince = data.some(item => item.province);
            const provinceColumn = hasProvince ? '<th>ÙˆÙ„Ø§ÛŒØª</th>' : '';
            
            let html = `
                <h3>ğŸ“‹ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (${data.length} Ø±Ú©ÙˆØ±Ø¯ØŒ ${data.length * 2} ØµÙØ­Ù‡)</h3>
                <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù†</th>
                                <th>Ø´Ù…Ø§Ø±Ù‡ Ø´Ø§Ø³ÛŒ</th>
                                ${provinceColumn}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Show first 20 rows for preview
            const previewRows = data.slice(0, 20);
            previewRows.forEach((item, index) => {
                const provinceCell = hasProvince ? `<td>${item.province || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>` : '';
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.engineNo || 'N/A'}</td>
                        <td>${item.chassisNo || 'N/A'}</td>
                        ${provinceCell}
                    </tr>
                `;
            });
            
            if (data.length > 20) {
                const colspan = hasProvince ? 4 : 3;
                html += `
                    <tr>
                        <td colspan="${colspan}" style="text-align: center; color: #666; font-style: italic;">
                            ... Ùˆ ${data.length - 20} Ø±Ú©ÙˆØ±Ø¯ Ø¯ÛŒÚ¯Ø±
                        </td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 10px; color: #28a745;">
                    âœ… Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆÙ„ÛŒØ¯ ${data.length * 2} ØµÙØ­Ù‡ A4 (Û² ØµÙØ­Ù‡ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±Ú©ÙˆØ±Ø¯)
                </p>
                <p style="color: #666; font-size: 13px;">
                    ${hasProvince ? 'Ù‡Ø± ØµÙØ­Ù‡ Ø´Ø§Ù…Ù„ Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù†ØŒ Ø´Ø§Ø³ÛŒ Ùˆ ÙˆÙ„Ø§ÛŒØª Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.' : 'Ù‡Ø± ØµÙØ­Ù‡ Ø´Ø§Ù…Ù„ Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù† Ùˆ Ø´Ø§Ø³ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.'}
                </p>
            `;
            
            previewDiv.innerHTML = html;
        }

        // Insert placeholder in editor
        function insertPlaceholder(type) {
            const editor = document.getElementById('editor');
            let placeholder;
            
            switch(type) {
                case 'engine':
                    placeholder = '<span class="placeholder" data-type="engine">[ENGINE_NUMBER]</span>';
                    break;
                case 'chassis':
                    placeholder = '<span class="placeholder" data-type="chassis">[CHASSIS_NUMBER]</span>';
                    break;
                case 'province':
                    placeholder = '<span class="placeholder" data-type="province">[PROVINCE]</span>';
                    break;
                default:
                    return;
            }
            
            document.execCommand('insertHTML', false, placeholder);
            editor.focus();
            updateFormatting();
            
            // Show message about what was inserted
            const typeNames = {
                'engine': 'Ø´Ù…Ø§Ø±Ù‡ Ø§Ù†Ø¬Ù†',
                'chassis': 'Ø´Ù…Ø§Ø±Ù‡ Ø´Ø§Ø³ÛŒ', 
                'province': 'ÙˆÙ„Ø§ÛŒØª'
            };
            showStatus(`âœ… Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† ${typeNames[type]} Ø¯Ø±Ø¬ Ø´Ø¯`, 'success');
        }

        // Clear editor
        function clearEditor() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
                document.getElementById('editor').innerHTML = '';
                updateFormatting();
                showStatus('âœ… ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ù¾Ø§Ú© Ø´Ø¯', 'success');
            }
        }

        // Generate PDFs in batches
        async function generatePDFs() {
            if (excelData.length === 0) {
                showStatus('âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            const loading = document.getElementById('loading');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            loading.classList.add('active');
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';

            try {
                // Get template content
                const templateContent = document.getElementById('editor').innerHTML;
                const batchSize = parseInt(document.getElementById('batchSize').value) || 25;
                const totalRecords = excelData.length;
                const totalBatches = Math.ceil(totalRecords / batchSize);
                
                showStatus(`ğŸ”„ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ: ${totalBatches} Ø¯Ø³ØªÙ‡ ${batchSize} Ø±Ú©ÙˆØ±Ø¯ÛŒ`, 'success');
                
                // Create a new PDF document
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Process in batches
                for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                    const startIndex = batchIndex * batchSize;
                    const endIndex = Math.min(startIndex + batchSize, totalRecords);
                    const batchRecords = excelData.slice(startIndex, endIndex);
                    
                    showStatus(`ğŸ”„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙ‡ ${batchIndex + 1}/${totalBatches} (Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ ${startIndex + 1}-${endIndex})`, 'success');
                    
                    for (let i = 0; i < batchRecords.length; i++) {
                        const record = batchRecords[i];
                        const recordIndex = startIndex + i;
                        
                        // Calculate page number (starting from 1)
                        const pageNumber = recordIndex + 1;
                        
                        // Generate content with all placeholders
                        let pageContent = templateContent
                            .replace(/\[ENGINE_NUMBER\]/g, record.engineNo)
                            .replace(/\[CHASSIS_NUMBER\]/g, record.chassisNo)
                            .replace(/\[PROVINCE\]/g, record.province || '');
                        
                        // Create two identical pages for each record
                        for (let pageNum = 0; pageNum < 2; pageNum++) {
                            // Create temporary div for rendering
                            const tempDiv = document.createElement('div');
                            
                            tempDiv.className = 'a4-paper';
                            tempDiv.style.position = 'absolute';
                            tempDiv.style.left = '-9999px'; // Hide off-screen
                            tempDiv.style.fontFamily = 'Arial, sans-serif';
                            tempDiv.style.paddingRight = '1.27cm';
                            tempDiv.style.paddingLeft = '1.27cm';
                            tempDiv.innerHTML = `
                                <div class="header-image" style="text-align: center; height: auto; margin: 0; padding: 0;">
                                    <img src="./header.JPG" style="max-width: 350px; height: auto;" alt="Header Image">
                                </div>
                                <div class="fixed-top-right" style="position: absolute; top: 30px; right: 25px; direction: rtl; text-align: right; font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; line-height: 1.5; white-space: pre-wrap;">
                                    ${document.getElementById('fixedText').value}
                                </div>
                                <div class="editable-area arabic-text" style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
                                    ${pageContent}
                                </div>
                                <!-- NEW: Page number element added here -->
                                <div class="page-number" style="position: absolute; bottom: 40px; left: 30px; font-size: 18px; font-family: Arial, sans-serif; color: #000; z-index: 10;">
                                    [${pageNumber}]
                                </div>
                                <div style="position: absolute; bottom: 30px; width: 85%; display: flex; justify-content: center;">
                                    <img src="./footer.JPG" style="max-width: 90%; height: auto;" alt="Footer Image">
                                </div>
                            `;
                            
                            document.body.appendChild(tempDiv);
                            
                            // Convert to canvas with optimized settings
                            const canvas = await html2canvas(tempDiv, {
                                scale: 1.5,
                                useCORS: true,
                                logging: false,
                                backgroundColor: '#ffffff',
                                removeContainer: true
                            });
                            
                            // Add page to PDF
                            if (recordIndex > 0 || i > 0 || pageNum > 0) {
                                pdf.addPage();
                            }
                            
                            // Use JPEG compression to save memory
                            pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, 210, 297);
                            
                            // Clean up canvas memory
                            canvas.width = 0;
                            canvas.height = 0;
                            
                            // Remove temporary div
                            document.body.removeChild(tempDiv);
                            
                            // Update progress
                            const totalPages = totalRecords * 2;
                            const currentPage = (recordIndex * 2) + (pageNum + 1);
                            const progress = Math.round((currentPage / totalPages) * 100);
                            
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `${progress}% (${currentPage}/${totalPages} ØµÙØ­Ù‡)`;
                        }
                        
                        // Force garbage collection hint
                        if (i % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }
                    
                    // Clear batch memory
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // Save PDF
                const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
                pdf.save(`Ø§Ø³Ù†Ø§Ø¯_Ù…ÙˆÙ†ØªØ§Ú˜_${timestamp}_${totalRecords}_Ø±Ú©ÙˆØ±Ø¯.pdf`);
                
                showStatus(`âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ${totalRecords * 2} ØµÙØ­Ù‡ A4 ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯!`, 'success');
                progressBar.style.width = '100%';
                progressText.textContent = 'Û±Û°Û°Ùª Ú©Ø§Ù…Ù„!';
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showStatus(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ PDF: ${error.message}`, 'error');
            } finally {
                loading.classList.remove('active');
                // Keep progress visible for a moment
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 3000);
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            setTimeout(() => {
                if (statusDiv.textContent === message) {
                    statusDiv.className = 'status';
                }
            }, 10000);
        }

        // PWA Installation
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        document.getElementById('installBtn').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Make functions available globally
        window.insertPlaceholder = insertPlaceholder;
        window.clearEditor = clearEditor;
        window.generatePDFs = generatePDFs;
        window.installPWA = installPWA;
        window.formatText = formatText;
        window.toggleFormat = toggleFormat;
        window.updateFormatting = updateFormatting;
        window.saveTemplate = saveTemplate;
        window.loadDefaultTemplate = loadDefaultTemplate;
        window.exportTemplate = exportTemplate;
        window.importTemplate = importTemplate;
        window.deleteTemplate = deleteTemplate;
    </script>
</body>
</html>
