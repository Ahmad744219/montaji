<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆØªØ±Ø³Ø§ÛŒÚ©Ù„ â€“ A3 (Ø¨Ù‡Ø¨ÙˆØ¯ Ø³Ø±Ø¨Ø±Ú¯/Ù¾Ø§ÙˆØ±Ù‚ÛŒ)</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <style>
    /* reset & base */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Arial', sans-serif; }
    body { background: #f0f2f5; padding: 12px 10px; display: flex; flex-direction: column; align-items: center; }
    .main-container { max-width: 1400px; width: 100%; }

    /* header & controls */
    .app-header {
      background: linear-gradient(145deg, #1e3c5c, #2b4c7c);
      color: white;
      padding: 12px 14px;
      border-radius: 12px;
      margin-bottom: 14px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.10);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .app-header h1 { font-size: 1.05rem; font-weight: 600; }
    .app-header h1 small { font-size: 0.85rem; opacity: 0.9; display: block; margin-top: 4px; }
    .status-badge { background: #e9f0f9; border-radius: 24px; padding: 4px 10px; color: #1e3c5c; font-weight: 600; font-size: 0.86rem; }

    .input-panel {
      background: white;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.04);
      margin-bottom: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: flex-end;
      border: 1px solid #e6edf5;
    }
    .file-zone { flex: 2; min-width: 200px; }
    .file-label { background: #eef3f9; padding: 8px 10px; border-radius: 22px; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; color: #1e3c5c; border: 1px dashed #7b9eb5; cursor: pointer; font-size: 0.9rem; }
    .file-info { margin-top: 6px; font-size: 0.82rem; color: #2c3e50; word-break: break-word; }

    .image-upload-row { display: flex; flex-wrap: wrap; gap: 10px; margin: 8px 0; }
    .image-upload-item { display: flex; flex-direction: column; gap: 6px; }
    .image-preview { max-width: 140px; max-height: 50px; border: 1px solid #ccc; border-radius: 6px; padding: 2px; background: #fafafa; object-fit: contain; }

    .date-fields { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end; }
    .field-group { display: flex; flex-direction: column; min-width: 95px; }
    .field-group label { font-weight: 600; color: #1e3c5c; margin-bottom: 4px; font-size: 0.82rem; }
    .field-group input { border: 1px solid #cbdbe6; border-radius: 18px; padding: 7px 8px; font-size: 0.95rem; background: #fafcff; transition: 0.12s; direction: rtl; }

    .action-buttons { display: flex; gap: 8px; align-items: center; margin-left: auto; flex-wrap: wrap; }
    .btn-primary { background: #1e3c5c; border: none; padding: 8px 12px; border-radius: 24px; color: white; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(30,60,92,0.18); }
    .btn-secondary { background: white; border: 1px solid #a0b8cf; padding: 8px 10px; border-radius: 24px; font-weight: 600; color: #1e3c5c; cursor: pointer; }
    .btn-primary:hover { opacity: 0.95; }
    .btn-secondary:hover { background: #eef6fc; }

    /* PREVIEW / SHEETS (A3 landscape) */
    .a4-preview {
      width: 100%;
      background: #eef4fb;
      border-radius: 12px;
      padding: 8px;
      margin: 12px 0;
      border: 1px solid #dbe8f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      overflow-x: auto;
    }

    /* A3 landscape printable width = 420mm - margins */
    .a4-paper {
      width: calc(420mm - 20mm);
      background: white;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      margin: 0 auto;
      display: block;
      direction: rtl;
      font-family: 'Arial', 'Segoe UI', sans-serif;
      page-break-after: always;
      overflow: visible;
      border-radius: 4px;
      padding: 6px;
    }

    /* header/footer container (90px) â€” images centered and framed */
    .header-container {
      width: 100%;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg,#fbfdff,#f7fbff);
      overflow: hidden;
      padding: 6px 10px;
      border-bottom: 1px dashed #d0d7de;
    }
    .footer-container {
      width: 100%;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg,#fbfdff,#f7fbff);
      overflow: hidden;
      padding: 6px 10px;
      border-top: 1px dashed #d0d7de;
    }

    /* improved sheet image styles */
    .sheet-header-img,
    .sheet-footer-img {
      max-width: 98%;
      max-height: calc(100% - 6px); /* leave small padding inside container */
      display: block;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform .18s ease;
      object-position: center center;
      /* object-fit will be set dynamically by JS (cover/contain) */
    }
    .sheet-header-img:hover,
    .sheet-footer-img:hover { transform: translateY(-2px); }

    /* small preview images in editor follow same 'nice' styling */
    #headerPreview, #footerPreview {
      max-width: 140px;
      max-height: 48px;
      object-fit: contain;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      display: inline-block;
    }

    .table-container { padding: 4px 6px; background: white; overflow: visible; }

    /* table: increased font, single-line, ellipsis */
    .motor-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 10pt;
      line-height: 1.05;
      border: 1px solid #111;
    }

    /* column widths tuned for A3 landscape (sum ~100%) */
    .motor-table th:nth-child(1)  { width: 5%; }   /* Ø´Ù…Ø§Ø±Ù‡ */
    .motor-table th:nth-child(2)  { width: 17%; }  /* Ù†Ø§Ù… Ø´Ø±Ú©Øª */
    .motor-table th:nth-child(3)  { width: 6%; }   /* Ù†Ø§Ù… Ø³ÛŒÚ©Ù„ */
    .motor-table th:nth-child(4)  { width: 14%; }  /* Ø§Ù†Ø¬ÛŒÙ† */
    .motor-table th:nth-child(5)  { width: 15%; }  /* Ø´Ø§Ø³ÛŒ */
    .motor-table th:nth-child(6)  { width: 6%; }   /* Ø³ÛŒ Ø³ÛŒ */
    .motor-table th:nth-child(7)  { width: 6%; }   /* Ù…Ø¯Ù„ */
    .motor-table th:nth-child(8)  { width: 8%; }   /* Ù…Ø±Ø¬Ø¹ */
    .motor-table th:nth-child(9)  { width: 6%; }   /* Ù…Ú©ØªÙˆØ¨ */
    .motor-table th:nth-child(10) { width: 11%; }  /* ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ */
    .motor-table th:nth-child(11) { width: 6%; }   /* ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ */

    .motor-table th, .motor-table td {
      border: 1px solid #2d2d2d;
      padding: 6px 8px;
      text-align: center;
      vertical-align: middle;
      background-color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 10pt;
    }
    .motor-table th { background: #e9f1f9; font-weight: 700; color: #07223b; font-size: 9pt; }

    /* specific smaller padding for reference and date columns */
    .motor-table th:nth-child(8), .motor-table td:nth-child(8),
    .motor-table th:nth-child(10), .motor-table td:nth-child(10),
    .motor-table th:nth-child(11), .motor-table td:nth-child(11) {
      padding: 3px 5px;
      font-size: 9.5pt;
    }

    /* responsive preview: horizontal scroll if necessary */
    @media (max-width: 1400px) { .a4-paper { width: calc(420mm - 40mm); } }
    @media (max-width: 1000px) { .a4-paper { width: calc(420mm - 60mm); } }
    @media (max-width: 700px)  { .a4-paper { width: calc(420mm - 80mm); } }

    /* Print: A3 landscape and tidy UI removal; keep header/footer heights at 90px */
    @page { size: A3 landscape; margin: 10mm; }
    @media print {
      .app-header, .input-panel, .btn-primary, .btn-secondary, .file-label, .status-badge, .image-preview, .small-note, #globalMessage { display: none !important; }
      body { background: white; padding: 0; }
      .a4-preview { background: white; border: none; padding: 0; }
      .a4-paper { width: auto; margin: 0; box-shadow: none; border-radius: 0; page-break-after: always; overflow: visible; padding: 0; }
      .header-container { height: 90px; padding: 4px; overflow: hidden; }
      .footer-container { height: 90px; padding: 4px; overflow: hidden; }
      .table-container { padding: 0 8mm; overflow: visible; }
      .motor-table { font-size: 9pt; }
      .motor-table th, .motor-table td { padding: 4px 6px; }
      .sheet-header-img, .sheet-footer-img { max-height: calc(100% - 6px); }
    }

    /* messages */
    .message { padding: 10px 12px; border-radius: 18px; margin: 12px 0; font-weight: 500; font-size: 0.95rem; }
    .success { background: #dff0d8; color: #2e6b2e; border: 1px solid #b2dba2; }
    .error { background: #f8ddda; color: #a94442; border: 1px solid #ebbcbc; }
    .info { background: #d9edf7; color: #31708f; }
    .small-note { color: #2c3e50; background: #f8fbff; padding: 10px; border-radius: 12px; font-size: 0.86rem; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Top Menu with three buttons that redirect -->
        <div class="top-menu" style="background: linear-gradient(135deg, #2c3e50, #4a6491); padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; display: flex; gap: 15px; justify-content: flex-end; box-shadow: 0 2px 4px rgba(0,0,0,0.1); direction: rtl;">
            <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: Arial, sans-serif;" onclick="location.href='./index.html'">Ù…Ú©ØªÙˆØ¨ Ø¬ÙØªÛŒ</button>
            <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: Arial, sans-serif;" onclick="location.href='./big.html'">Ø³Ø§Ø®Øª Ù…Ú©ØªÙˆØ¨ ØªÚ©ÛŒ</button>
            <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: Arial, sans-serif;" onclick="location.href='./jadval.html'">Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„</button>
        </div>
    <div class="app-header">
      <div>
        <h1>ğŸ“‹ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ÛŒ A3 Ù…ÙˆØªØ±Ø³Ø§ÛŒÚ©Ù„<br><small>Ø³Ø±Ø¨Ø±Ú¯/Ù¾Ø§ÙˆØ±Ù‚ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡</small></h1>
      </div>
      <div class="status-badge" id="recordCounter">ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡</div>
    </div>

    <div class="input-panel">
      <div class="file-zone">
        <input type="file" id="excelFileInput" accept=".xlsx, .xls, .csv" style="display: none;">
        <label for="excelFileInput" class="file-label">ğŸ“‚ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Excel (Ù…ÙˆØªØ±Ø³Ø§ÛŒÚ©Ù„)</label>
        <div class="file-info" id="fileInfo">ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
      </div>

      <div class="image-upload-row">
        <div class="image-upload-item">
          <label>ğŸ–¼ï¸ Ø³Ø±Ø¨Ø±Ú¯</label>
          <input type="file" id="headerImageInput" accept="image/*" style="display: none;">
          <label for="headerImageInput" class="file-label" style="padding: 6px 10px;">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±Ø¨Ø±Ú¯</label>
          <img id="headerPreview" class="image-preview" src="#" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø³Ø±Ø¨Ø±Ú¯" style="display: none;">
        </div>
        <div class="image-upload-item">
          <label>ğŸ–¼ï¸ Ù¾Ø§ÙˆØ±Ù‚ÛŒ</label>
          <input type="file" id="footerImageInput" accept="image/*" style="display: none;">
          <label for="footerImageInput" class="file-label" style="padding: 6px 10px;">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÙˆØ±Ù‚ÛŒ</label>
          <img id="footerPreview" class="image-preview" src="#" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾Ø§ÙˆØ±Ù‚ÛŒ" style="display: none;">
        </div>
      </div>

      <div class="date-fields">
        <div class="field-group">
          <label>ğŸ”¢ Ø´Ø±ÙˆØ¹ Ù…Ú©ØªÙˆØ¨</label>
          <input type="number" id="maktubStart" value="101" min="1">
        </div>
        <div class="field-group">
          <label>ğŸ“… ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ</label>
          <input type="text" id="dateShamsi" value="Û±Û´Û°Û³/Û°Û²/Û±Ûµ">
        </div>
        <div class="field-group">
          <label>ğŸŒ™ ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ</label>
          <input type="text" id="dateQamari" value="Û±Û´Û´Ûµ/Û±Û°/Û°Ûµ">
        </div>
        <div class="field-group">
          <label>ğŸ”¢ Ø³Ø·Ø± Ø¯Ø± Ù‡Ø± Ø¨Ø±Ú¯</label>
          <input type="number" id="rowsPerPage" value="25" min="1" max="500">
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn-primary" id="generateBtn">âš¡ ØªÙˆÙ„ÛŒØ¯ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§</button>
        <button class="btn-secondary" id="printBtn">ğŸ–¨ï¸ Ú†Ø§Ù¾ / PDF</button>
      </div>
    </div>

    <div id="globalMessage" class="message" style="display: none;"></div>

    <!-- Preview area -->
    <div class="a4-preview" id="a4Preview"></div>

    <div class="small-note">
      â“˜ Ø³Ø±Ø¨Ø±Ú¯ Ùˆ Ù¾Ø§ÙˆØ±Ù‚ÛŒ Ø§Ú©Ù†ÙˆÙ† Ø¨Ù‡ ØµÙˆØ±Øª Ù‡ÙˆØ´Ù…Ù†Ø¯Ø§Ù†Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯Ø› ØªØµÙˆÛŒØ± Ø´Ù…Ø§ Ø¨Ø§ Ù†Ø³Ø¨Øª Ø§ØµÙ„ÛŒ Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø§Ú¯Ø± ØªØµÙˆÛŒØ± Ù¾Ù‡Ù† Ø¨Ø§Ø´Ø¯ Ø·Ø¨ÛŒØ¹ÛŒâ€ŒØªØ± Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯.
    </div>
  </div>

  <script>
  (function() {
    // DOM elements
    const fileInput = document.getElementById('excelFileInput');
    const headerImageInput = document.getElementById('headerImageInput');
    const footerImageInput = document.getElementById('footerImageInput');
    const headerPreview = document.getElementById('headerPreview');
    const footerPreview = document.getElementById('footerPreview');
    const fileInfo = document.getElementById('fileInfo');
    const recordCounter = document.getElementById('recordCounter');
    const generateBtn = document.getElementById('generateBtn');
    const printBtn = document.getElementById('printBtn');
    const a4Preview = document.getElementById('a4Preview');
    const msgDiv = document.getElementById('globalMessage');
    const rowsPerPageInput = document.getElementById('rowsPerPage');

    let parsedRows = [];
    let headerImageUrl = null;
    let footerImageUrl = null;

    function showMessage(text, type = 'info', timeout = 5000) {
      msgDiv.style.display = 'block';
      msgDiv.className = `message ${type}`;
      msgDiv.innerText = text;
      if (timeout > 0) setTimeout(() => { msgDiv.style.display = 'none'; }, timeout);
    }

    function updateFileInfo(fileName, rowCount) {
      fileInfo.innerText = `ğŸ“„ ${fileName} | ${rowCount} Ø±Ú©ÙˆØ±Ø¯`;
      recordCounter.innerText = `${rowCount} Ø±Ø¯ÛŒÙ loaded`;
    }

    // ---------- Image helper: choose object-fit based on natural ratio ----------
    function adaptImageFit(imgEl) {
      // If image not loaded yet, bind onload
      if (!imgEl.complete || imgEl.naturalWidth === 0) {
        imgEl.addEventListener('load', () => adaptImageFit(imgEl), { once: true });
        return;
      }
      const w = imgEl.naturalWidth;
      const h = imgEl.naturalHeight;
      const ratio = w / h;
      // wide banners -> cover (fills width nicely)
      if (ratio >= 2.2) {
        imgEl.style.objectFit = 'cover';
      } else {
        // logos / tall images -> contain (don't crop)
        imgEl.style.objectFit = 'contain';
      }
      // ensure image never exceeds container height/width (CSS limits already)
      imgEl.style.maxWidth = '98%';
      imgEl.style.maxHeight = 'calc(100% - 6px)';
      imgEl.style.objectPosition = 'center center';
    }

    // ---------- Excel parsing ----------
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) { fileInfo.innerText = 'ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡'; return; }
      fileInfo.innerText = `ğŸ“„ ${file.name} (Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù†...)`;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });

          // Find header row (contains 'Ø³ÛŒ Ø³ÛŒ', 'Ø§Ù†Ø¬Ù†', 'Ø´Ø§Ø³ÛŒ')
          let headerRowIndex = -1;
          let headers = [];
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if (!Array.isArray(row)) continue;
            const rowCells = row.map(c => (c || '').toString().trim());
            if (rowCells.some(c => c.includes('Ø³ÛŒ Ø³ÛŒ')) &&
                rowCells.some(c => c.includes('Ø§Ù†Ø¬Ù†')) &&
                rowCells.some(c => c.includes('Ø´Ø§Ø³ÛŒ'))) {
              headerRowIndex = i; headers = rowCells; break;
            }
          }
          if (headerRowIndex === -1) {
            showMessage('âŒ Ø³Ø±Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± (Ø³ÛŒ Ø³ÛŒ, Ø§Ù†Ø¬Ù†, Ø´Ø§Ø³ÛŒ) Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯', 'error');
            fileInfo.innerText = `ğŸ“„ ${file.name} (Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§)`; return;
          }

          // Column mapping
          const colMap = { serialNo:-1, company:-1, engine:-1, chassis:-1, cc:-1, model:-1, reference:-1 };
          for (let idx=0; idx<headers.length; idx++) {
            const cell = headers[idx].replace(/[\s\u200c]+/g,' ').trim();
            if (cell.includes('Ø´Ù…Ø§Ø±Ù‡')) colMap.serialNo = idx;
            if (cell.includes('Ø§Ø³Ù… Ø´Ø±Ú©Øª')) colMap.company = idx;
            if (cell.includes('Ø§Ù†Ø¬Ù†')) colMap.engine = idx;
            if (cell.includes('Ø´Ø§Ø³ÛŒ')) colMap.chassis = idx;
            if (cell.includes('Ø³ÛŒ Ø³ÛŒ')) colMap.cc = idx;
            if (cell.includes('Ù…Ø¯Ù„')) colMap.model = idx;
            if (cell.includes('Ù…Ø±Ø¬Ø¹')) colMap.reference = idx;
          }
          if (colMap.serialNo===-1 || colMap.company===-1 || colMap.engine===-1 || colMap.chassis===-1) {
            showMessage('âŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ (Ø´Ù…Ø§Ø±Ù‡, Ø§Ø³Ù… Ø´Ø±Ú©Øª, Ø§Ù†Ø¬Ù†, Ø´Ø§Ø³ÛŒ) ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
            fileInfo.innerText = `ğŸ“„ ${file.name} (Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù‚Øµ)`; return;
          }

          // Extract data rows
          const dataRows = [];
          for (let r = headerRowIndex + 1; r < rows.length; r++) {
            const row = rows[r];
            if (!Array.isArray(row) || row.length === 0) continue;
            const serial = row[colMap.serialNo] ? row[colMap.serialNo].toString().trim() : '';
            if (serial === '') continue;
            dataRows.push({
              serialNo: serial,
              company: row[colMap.company] ? row[colMap.company].toString().trim() : '',
              engine: row[colMap.engine] ? row[colMap.engine].toString().trim() : '',
              chassis: row[colMap.chassis] ? row[colMap.chassis].toString().trim() : '',
              cc: (colMap.cc !== -1 && row[colMap.cc]) ? row[colMap.cc].toString().trim() : '',
              model: (colMap.model !== -1 && row[colMap.model]) ? row[colMap.model].toString().trim() : '',
              reference: (colMap.reference !== -1 && row[colMap.reference]) ? row[colMap.reference].toString().trim() : '',
            });
          }

          if (dataRows.length === 0) {
            showMessage('âŒ Ù‡ÛŒÚ† Ø±Ø¯ÛŒÙ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
            fileInfo.innerText = `ğŸ“„ ${file.name} (Û° Ø±Ú©ÙˆØ±Ø¯)`; return;
          }
          parsedRows = dataRows;
          updateFileInfo(file.name, parsedRows.length);
          showMessage(`âœ… ${parsedRows.length} Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, 'success');
        } catch (err) {
          console.error(err);
          showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„: ' + err.message, 'error');
          fileInfo.innerText = `ğŸ“„ ${file.name} (Ø®Ø·Ø§)`;
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // ---------- Header preview handling ----------
    headerImageInput.addEventListener('change', function(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        headerImageUrl = event.target.result;
        headerPreview.src = headerImageUrl;
        headerPreview.style.display = 'inline-block';
        headerPreview.style.objectFit = 'contain';
        headerPreview.style.maxHeight = '48px';
        // adapt fit by creating a temporary Image object
        const tmp = new Image();
        tmp.onload = () => {
          if (tmp.naturalWidth / tmp.naturalHeight >= 2.2) headerPreview.style.objectFit = 'cover';
          else headerPreview.style.objectFit = 'contain';
        };
        tmp.src = headerImageUrl;
      };
      reader.readAsDataURL(file);
    });

    // ---------- Footer preview handling ----------
    footerImageInput.addEventListener('change', function(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        footerImageUrl = event.target.result;
        footerPreview.src = footerImageUrl;
        footerPreview.style.display = 'inline-block';
        footerPreview.style.objectFit = 'contain';
        footerPreview.style.maxHeight = '48px';
        const tmp = new Image();
        tmp.onload = () => {
          if (tmp.naturalWidth / tmp.naturalHeight >= 2.2) footerPreview.style.objectFit = 'cover';
          else footerPreview.style.objectFit = 'contain';
        };
        tmp.src = footerImageUrl;
      };
      reader.readAsDataURL(file);
    });

    // ---------- Generate multi-page A3 sheets ----------
    function generatePages() {
      if (parsedRows.length === 0) { showMessage('â›” Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error'); return; }
      const startMaktub = parseInt(document.getElementById('maktubStart').value, 10);
      if (isNaN(startMaktub)) { showMessage('â›” Ø´Ù…Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ù…Ú©ØªÙˆØ¨ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
      const shamsi = document.getElementById('dateShamsi').value.trim() || '---';
      const qamari = document.getElementById('dateQamari').value.trim() || '---';
      let rowsPerPage = parseInt(rowsPerPageInput.value, 10) || 25; if (rowsPerPage < 1) rowsPerPage = 25;

      a4Preview.innerHTML = '';
      const totalRows = parsedRows.length;
      const totalPages = Math.ceil(totalRows / rowsPerPage);

      for (let page = 0; page < totalPages; page++) {
        const startIdx = page * rowsPerPage;
        const endIdx = Math.min(startIdx + rowsPerPage, totalRows);
        const pageRows = parsedRows.slice(startIdx, endIdx);

        const sheet = document.createElement('div'); sheet.className = 'a4-paper';

        // Header
        const headerDiv = document.createElement('div'); headerDiv.className = 'header-container';
        if (headerImageUrl) {
          const img = document.createElement('img');
          img.className = 'sheet-header-img';
          img.src = headerImageUrl;
          // adapt fit when loaded
          img.addEventListener('load', () => adaptImageFit(img), { once: true });
          headerDiv.appendChild(img);
        } else {
          headerDiv.innerText = ' [ Ø³Ø±Ø¨Ø±Ú¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ ] ';
          headerDiv.style.color = '#777';
          headerDiv.style.fontSize = '12px';
          headerDiv.style.display = 'flex';
          headerDiv.style.alignItems = 'center';
          headerDiv.style.justifyContent = 'center';
        }
        sheet.appendChild(headerDiv);

        // Table
        const tableContainer = document.createElement('div'); tableContainer.className = 'table-container';
        let tableHtml = `<table class="motor-table" dir="rtl"><thead><tr>
          <th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù†Ø§Ù… Ø´Ø±Ú©Øª</th><th>Ù†Ø§Ù… Ø³ÛŒÚ©Ù„</th><th>Ø§Ù†Ø¬ÛŒÙ†</th><th>Ø´Ø§Ø³ÛŒ</th>
          <th>Ø³ÛŒ Ø³ÛŒ</th><th>Ù…Ø¯Ù„</th><th>Ù…Ø±Ø¬Ø¹</th><th>Ù…Ú©ØªÙˆØ¨</th><th>ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ</th><th>ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ</th>
        </tr></thead><tbody>`;
        for (let i = 0; i < pageRows.length; i++) {
          const r = pageRows[i];
          const maktubNumber = startMaktub + (startIdx + i);
          const esc = s => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
          tableHtml += `<tr>
            <td title="${esc(r.serialNo)}">${esc(r.serialNo)}</td>
            <td title="${esc(r.company)}">${esc(r.company)}</td>
            <td title="BAJAJ">BAJAJ</td>
            <td title="${esc(r.engine)}">${esc(r.engine)}</td>
            <td title="${esc(r.chassis)}">${esc(r.chassis)}</td>
            <td title="${esc(r.cc)}">${esc(r.cc)}</td>
            <td title="${esc(r.model)}">${esc(r.model)}</td>
            <td title="${esc(r.reference)}">${esc(r.reference)}</td>
            <td title="${maktubNumber}">${maktubNumber}</td>
            <td title="${esc(shamsi)}">${esc(shamsi)}</td>
            <td title="${esc(qamari)}">${esc(qamari)}</td>
          </tr>`;
        }
        tableHtml += '</tbody></table>';
        tableContainer.innerHTML = tableHtml;
        sheet.appendChild(tableContainer);

        // Footer
        const footerDiv = document.createElement('div'); footerDiv.className = 'footer-container';
        if (footerImageUrl) {
          const img = document.createElement('img');
          img.className = 'sheet-footer-img';
          img.src = footerImageUrl;
          img.addEventListener('load', () => adaptImageFit(img), { once: true });
          footerDiv.appendChild(img);
        } else {
          footerDiv.innerText = ' [ Ù¾Ø§ÙˆØ±Ù‚ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ ] ';
          footerDiv.style.color = '#777';
          footerDiv.style.fontSize = '12px';
          footerDiv.style.display = 'flex';
          footerDiv.style.alignItems = 'center';
          footerDiv.style.justifyContent = 'center';
        }
        sheet.appendChild(footerDiv);

        a4Preview.appendChild(sheet);
      }

      showMessage(`âœ… ${totalPages} Ø¨Ø±Ú¯ A3 Ø¨Ø§ Ù…Ø¬Ù…ÙˆØ¹ ${totalRows} Ø³Ø·Ø± ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯`, 'success');
    }

    function printSheets() {
      if (a4Preview.children.length === 0) { showMessage('â›” Ø§Ø¨ØªØ¯Ø§ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
      window.print();
    }

    generateBtn.addEventListener('click', generatePages);
    printBtn.addEventListener('click', printSheets);

    // initial hint
    showMessage('ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ø±ÙˆÛŒ "ØªÙˆÙ„ÛŒØ¯ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.', 'info', 4000);
  })();
  </script>
</body>
</html>
