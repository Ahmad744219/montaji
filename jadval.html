<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆØªØ±Ø³Ø§ÛŒÚ©Ù„ â€“ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ (Ù…Ø±Ø¬Ø¹ + Ù…Ú©ØªÙˆØ¨ Ø¯Ø³ØªÛŒ)</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <style>
    /* reset & base */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Arial', sans-serif; }
    body { background: #f0f2f5; padding: 12px 10px; display: flex; flex-direction: column; align-items: center; }
    .main-container { max-width: 1400px; width: 100%; }

    .app-header {
      background: linear-gradient(145deg, #1e3c5c, #2b4c7c);
      color: white;
      padding: 12px 14px;
      border-radius: 12px;
      margin-bottom: 14px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.10);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .app-header h1 { font-size: 1.05rem; font-weight: 600; }
    .app-header h1 small { font-size: 0.85rem; opacity: 0.9; display: block; margin-top: 4px; }
    .status-badge { background: #e9f0f9; border-radius: 24px; padding: 4px 10px; color: #1e3c5c; font-weight: 600; font-size: 0.86rem; }

    /* Ù¾Ù†Ù„ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ */
    .step-panel {
      background: white;
      border-radius: 12px;
      padding: 12px 15px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.04);
      margin-bottom: 18px;
      border: 1px solid #d9e4f0;
    }
    .step-title {
      font-size: 1rem;
      font-weight: 700;
      color: #1e3c5c;
      border-right: 5px solid #2b4c7c;
      padding-right: 10px;
      margin-bottom: 12px;
    }
    .file-zone { flex: 2; min-width: 200px; }
    .file-label { background: #eef3f9; padding: 8px 10px; border-radius: 22px; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; color: #1e3c5c; border: 1px dashed #7b9eb5; cursor: pointer; font-size: 0.9rem; }
    .file-info { margin-top: 6px; font-size: 0.82rem; color: #2c3e50; word-break: break-word; }

    .image-upload-row { display: flex; flex-wrap: wrap; gap: 15px; margin: 12px 0; }
    .image-upload-item { display: flex; flex-direction: column; gap: 6px; }
    .image-preview { max-width: 140px; max-height: 50px; border: 1px solid #ccc; border-radius: 6px; padding: 2px; background: #fafafa; object-fit: contain; }

    .date-fields { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; margin-top: 8px; }
    .field-group { display: flex; flex-direction: column; min-width: 95px; }
    .field-group label { font-weight: 600; color: #1e3c5c; margin-bottom: 4px; font-size: 0.82rem; }
    .field-group input { border: 1px solid #cbdbe6; border-radius: 18px; padding: 7px 8px; font-size: 0.95rem; background: #fafcff; transition: 0.12s; direction: rtl; }

    .action-buttons { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
    .btn-primary { background: #1e3c5c; border: none; padding: 8px 14px; border-radius: 24px; color: white; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(30,60,92,0.18); }
    .btn-secondary { background: white; border: 1px solid #a0b8cf; padding: 8px 12px; border-radius: 24px; font-weight: 600; color: #1e3c5c; cursor: pointer; }
    .btn-success { background: #2e6b2e; border: none; padding: 8px 14px; border-radius: 24px; color: white; font-weight: 600; cursor: pointer; }
    
    .btn-primary:hover { opacity: 0.95; }
    .btn-secondary:hover { background: #eef6fc; }

    /* PREVIEW */
    .a4-preview {
      width: 100%;
      background: #eef4fb;
      border-radius: 12px;
      padding: 8px;
      margin: 12px 0;
      border: 1px solid #dbe8f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      overflow-x: auto;
    }
    .a4-paper {
      width: calc(420mm - 20mm);
      background: white;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      margin: 0 auto;
      display: block;
      direction: rtl;
      font-family: 'Arial', 'Segoe UI', sans-serif;
      page-break-after: always;
      overflow: visible;
      border-radius: 4px;
      padding: 6px;
    }
    .header-container, .footer-container {
      width: 100%;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg,#fbfdff,#f7fbff);
      overflow: hidden;
      padding: 6px 10px;
      border-bottom: 1px dashed #d0d7de;
    }
    .footer-container { border-top: 1px dashed #d0d7de; border-bottom: none; }
    .sheet-header-img, .sheet-footer-img {
      max-width: 98%;
      max-height: calc(100% - 6px);
      display: block;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform .18s ease;
      object-position: center center;
    }
    .table-container { padding: 4px 6px; background: white; overflow: visible; }
    
    /* Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ Ú†ÛŒØ¯Ù…Ø§Ù† Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ A3 landscape */
    .motor-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed; /* fixed still, but we ensure columns are wide enough */
      font-size: 9.5pt;    /* slightly smaller to fit more */
      line-height: 1.2;
      border: 1px solid #111;
    }
    
    /* ØªÙˆØ²ÛŒØ¹ Ù…Ù†Ø§Ø³Ø¨ Ø¹Ø±Ø¶ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ - Ù…Ø¬Ù…ÙˆØ¹ 100% */
    .motor-table th:nth-child(1)  { width: 5%; }   /* Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„ */
    .motor-table th:nth-child(2)  { width: 14%; }  /* Ù†Ø§Ù… Ø´Ø±Ú©Øª */
    .motor-table th:nth-child(3)  { width: 5%; }   /* Ù†Ø§Ù… Ø³ÛŒÚ©Ù„ (BAJAJ) */
    .motor-table th:nth-child(4)  { width: 12%; }  /* Ø§Ù†Ø¬ÛŒÙ† */
    .motor-table th:nth-child(5)  { width: 12%; }  /* Ø´Ø§Ø³ÛŒ */
    .motor-table th:nth-child(6)  { width: 5%; }   /* Ø³ÛŒ Ø³ÛŒ */
    .motor-table th:nth-child(7)  { width: 5%; }   /* Ù…Ø¯Ù„ */
    .motor-table th:nth-child(8)  { width: 9%; }   /* Ù…Ø±Ø¬Ø¹ */
    .motor-table th:nth-child(9)  { width: 8%; }   /* Ù…Ú©ØªÙˆØ¨ */
    .motor-table th:nth-child(10) { width: 13%; }  /* ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ (Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±) */
    .motor-table th:nth-child(11) { width: 12%; }  /* ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ */

    .motor-table th, .motor-table td {
      border: 1px solid #2d2d2d;
      padding: 4px 3px;        /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ú¯ÛŒØ±ÛŒ Ø¨Ù‡ØªØ± */
      text-align: center;
      vertical-align: middle;
      background-color: white;
      white-space: normal;     /* Ø§Ø¬Ø§Ø²Ù‡ Ø´Ú©Ø³ØªÙ† Ø®Ø· */
      word-break: break-word;  /* Ø´Ú©Ø³ØªÙ† Ú©Ù„Ù…Ø§Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ */
      overflow: visible;       /* Ø­Ø°Ù ellipsis */
      text-overflow: clip;     /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¹Ø¯Ù… Ù†Ù…Ø§ÛŒØ´ Ù†Ù‚Ø·Ù‡â€ŒÚ†ÛŒÙ† */
      font-size: 9.5pt;
    }
    .motor-table th { background: #e9f1f9; font-weight: 700; color: #07223b; font-size: 9pt; }

    /* Ø­Ø§Ø´ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± */
    .motor-table td:nth-child(10), .motor-table td:nth-child(11) {
      font-size: 9pt;  /* ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©ØªØ± */
      letter-spacing: 0.2px;
    }

    .province-separator {
      width: 100%;
      background: #d4e3fd;
      padding: 8px;
      margin: 5px 0;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1.1rem;
      color: #0b2d4b;
      text-align: center;
    }
    @media print {
      .app-header, .step-panel, .btn-primary, .btn-secondary, .btn-success, .file-label, .status-badge, .image-preview, .small-note, #globalMessage { display: none !important; }
      body { background: white; padding: 0; }
      .a4-preview { background: white; border: none; padding: 0; }
      .a4-paper { width: auto; margin: 0; box-shadow: none; border-radius: 0; page-break-after: always; }
      .header-container, .footer-container { height: 90px; }
      .motor-table { font-size: 9pt; }
      .motor-table th, .motor-table td { padding: 3px 2px; }
    }
    .message { padding: 10px 12px; border-radius: 18px; margin: 12px 0; font-weight: 500; }
    .success { background: #dff0d8; color: #2e6b2e; border: 1px solid #b2dba2; }
    .error { background: #f8ddda; color: #a94442; border: 1px solid #ebbcbc; }
    .info { background: #d9edf7; color: #31708f; }
    .small-note { color: #2c3e50; background: #f8fbff; padding: 10px; border-radius: 12px; font-size: 0.86rem; margin-top: 8px; }
  </style>
</head>
<body>
<div class="main-container">
  <!-- Ø³Ø±Ø¨Ø±Ú¯ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø³Ù‡ Ø¯Ú©Ù…Ù‡ -->
  <div class="app-header">
    <div>
      <h1>ğŸ“‹ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ÛŒ A3 Ù…ÙˆØªØ±Ø³Ø§ÛŒÚ©Ù„ â€“ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ<br><small>Ù…Ø±Ø¬Ø¹ + Ù…Ú©ØªÙˆØ¨ Ø¯Ø³ØªÛŒ/Ø®ÙˆØ¯Ú©Ø§Ø±</small></h1>
    </div>
    <div class="status-badge" id="recordCounter">Ù…Ø±Ø­Ù„Ù‡ Û±</div>
    <div class="top-menu" style="background: linear-gradient(135deg, #2c3e50, #4a6491); padding: 10px 20px; border-radius: 8px; display: flex; gap: 15px; justify-content: flex-end; direction: rtl;">
      <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer;" onclick="location.href='./index.html'">Ù…Ú©ØªÙˆØ¨ Ø¬ÙØªÛŒ</button>
      <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer;" onclick="location.href='./big.html'">Ø³Ø§Ø®Øª Ù…Ú©ØªÙˆØ¨ ØªÚ©ÛŒ</button>
      <button style="background: white; color: #2c3e50; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer;" onclick="location.href='./jadval.html'">Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„</button>
    </div>
  </div>

  <!-- Ù¾Ù†Ù„ Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„: ØªÙˆÙ„ÛŒØ¯ Ø§Ú©Ø³Ù„ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ Ù…Ú©ØªÙˆØ¨ Ùˆ ØªØ§Ø±ÛŒØ® -->
  <div class="step-panel">
    <div class="step-title">Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ùˆ ØªÙˆÙ„ÛŒØ¯ Ø§Ú©Ø³Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø±</div>
    <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
      <div class="file-zone">
        <input type="file" id="excelFileStep1" accept=".xlsx, .xls, .csv" style="display: none;">
        <label for="excelFileStep1" class="file-label">ğŸ“‚ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Excel (Ù…ÙˆØªØ±Ø³Ø§ÛŒÚ©Ù„)</label>
        <div class="file-info" id="fileInfoStep1">ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
      </div>
      <div class="date-fields">
        <div class="field-group">
          <label>ğŸ”¢ Ø´Ø±ÙˆØ¹ Ù…Ú©ØªÙˆØ¨</label>
          <input type="number" id="maktubStart" value="101" min="1">
        </div>
        <div class="field-group">
          <label>ğŸ“… ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ</label>
          <input type="text" id="dateShamsi" value="Û±Û´Û°Û³/Û°Û²/Û±Ûµ">
        </div>
        <div class="field-group">
          <label>ğŸŒ™ ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ</label>
          <input type="text" id="dateQamari" value="Û±Û´Û´Ûµ/Û±Û°/Û°Ûµ">
        </div>
      </div>
      <button class="btn-primary" id="generateStep1Btn">âš¡ Ù…Ø±Ø­Ù„Ù‡ Û±: ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø±</button>
    </div>
  </div>

  <!-- Ù¾Ù†Ù„ Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…: Ø¢Ù¾Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø± Ùˆ ØªÙÚ©ÛŒÚ© Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø±Ø¬Ø¹ (Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª) -->
  <div class="step-panel">
    <div class="step-title">Ù…Ø±Ø­Ù„Ù‡ Û²: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ù…Ø±Ø­Ù„Ù‡ Û± Ùˆ ØªÙˆÙ„ÛŒØ¯ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø±Ø¬Ø¹</div>
    <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
      <div class="file-zone">
        <input type="file" id="excelFileStep2" accept=".xlsx, .xls, .csv" style="display: none;">
        <label for="excelFileStep2" class="file-label">ğŸ“‚ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ù…Ø±Ø­Ù„Ù‡ Û±</label>
        <div class="file-info" id="fileInfoStep2">ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
      </div>
      <div class="field-group">
        <label>ğŸ”¢ Ø³Ø·Ø± Ø¯Ø± Ù‡Ø± Ø¨Ø±Ú¯</label>
        <input type="number" id="rowsPerPage" value="25" min="1" max="500">
      </div>
      <button class="btn-success" id="generateStep2Btn">ğŸ—‚ï¸ Ù…Ø±Ø­Ù„Ù‡ Û²: ØªÙˆÙ„ÛŒØ¯ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙÚ©ÛŒÚ© Ø´Ø¯Ù‡</button>
    </div>
  </div>

  <!-- Ø¢Ù¾Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ± Ø³Ø±Ø¨Ø±Ú¯ Ùˆ Ù¾Ø§ÙˆØ±Ù‚ÛŒ (Ù…Ø´ØªØ±Ú©) -->
  <div class="step-panel" style="background: #f5f9ff;">
    <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
      <div class="image-upload-item">
        <label>ğŸ–¼ï¸ Ø³Ø±Ø¨Ø±Ú¯</label>
        <input type="file" id="headerImageInput" accept="image/*" style="display: none;">
        <label for="headerImageInput" class="file-label" style="padding: 6px 10px;">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±Ø¨Ø±Ú¯</label>
        <img id="headerPreview" class="image-preview" src="#" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø³Ø±Ø¨Ø±Ú¯" style="display: none;">
      </div>
      <div class="image-upload-item">
        <label>ğŸ–¼ï¸ Ù¾Ø§ÙˆØ±Ù‚ÛŒ</label>
        <input type="file" id="footerImageInput" accept="image/*" style="display: none;">
        <label for="footerImageInput" class="file-label" style="padding: 6px 10px;">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÙˆØ±Ù‚ÛŒ</label>
        <img id="footerPreview" class="image-preview" src="#" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾Ø§ÙˆØ±Ù‚ÛŒ" style="display: none;">
      </div>
      <button class="btn-secondary" id="printBtn">ğŸ–¨ï¸ Ú†Ø§Ù¾ / PDF</button>
    </div>
  </div>

  <div id="globalMessage" class="message" style="display: none;"></div>

  <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ (Ù…Ø±Ø­Ù„Ù‡ Û²) -->
  <div class="a4-preview" id="a4Preview"></div>
  <div class="small-note">â“˜ Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§Ú©Ø³Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯. Ø³Ù¾Ø³ Ø¯Ø± ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³ØªÙˆÙ† "Ù†Ù…Ø¨Ø± Ù…Ú©ØªÙˆØ¨" Ø±Ø§ Ø¨Ù‡ Ø¯Ù„Ø®ÙˆØ§Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø§ÛŒÛŒØ¯. Ù…Ø±Ø­Ù„Ù‡ Û²: Ù‡Ù…ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯Ø› Ø§Ú¯Ø± "Ù†Ù…Ø¨Ø± Ù…Ú©ØªÙˆØ¨" Ù¾Ø± Ø¨Ø§Ø´Ø¯ Ù‡Ù…Ø§Ù† Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ†ØµÙˆØ±Øª Ù…Ù‚Ø¯Ø§Ø± "Ù…Ú©ØªÙˆØ¨" Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø±Ø¬ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.</div>
</div>

<script>
(function() {
  // -------------------- Ø¹Ù†Ø§ØµØ± DOM --------------------
  // Ù…Ø±Ø­Ù„Ù‡ 1
  const fileInputStep1 = document.getElementById('excelFileStep1');
  const fileInfoStep1 = document.getElementById('fileInfoStep1');
  const generateStep1Btn = document.getElementById('generateStep1Btn');
  const maktubStart = document.getElementById('maktubStart');
  const dateShamsi = document.getElementById('dateShamsi');
  const dateQamari = document.getElementById('dateQamari');

  // Ù…Ø±Ø­Ù„Ù‡ 2
  const fileInputStep2 = document.getElementById('excelFileStep2');
  const fileInfoStep2 = document.getElementById('fileInfoStep2');
  const generateStep2Btn = document.getElementById('generateStep2Btn');
  const rowsPerPageInput = document.getElementById('rowsPerPage');

  // ØªØµØ§ÙˆÛŒØ±
  const headerImageInput = document.getElementById('headerImageInput');
  const footerImageInput = document.getElementById('footerImageInput');
  const headerPreview = document.getElementById('headerPreview');
  const footerPreview = document.getElementById('footerPreview');

  // Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ùˆ Ù¾ÛŒØ§Ù…
  const a4Preview = document.getElementById('a4Preview');
  const msgDiv = document.getElementById('globalMessage');
  const printBtn = document.getElementById('printBtn');
  const recordCounter = document.getElementById('recordCounter');

  // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
  let headerImageUrl = null;
  let footerImageUrl = null;
  // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡ 1
  let step1RawData = { headers: null, rows: [] };

  // -------------------- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ --------------------
  function showMessage(text, type = 'info', timeout = 5000) {
    msgDiv.style.display = 'block';
    msgDiv.className = `message ${type}`;
    msgDiv.innerText = text;
    if (timeout > 0) setTimeout(() => { msgDiv.style.display = 'none'; }, timeout);
  }

  function adaptImageFit(imgEl) {
    if (!imgEl.complete || imgEl.naturalWidth === 0) {
      imgEl.addEventListener('load', () => adaptImageFit(imgEl), { once: true });
      return;
    }
    const ratio = imgEl.naturalWidth / imgEl.naturalHeight;
    imgEl.style.objectFit = ratio >= 2.2 ? 'cover' : 'contain';
    imgEl.style.maxWidth = '98%';
    imgEl.style.maxHeight = 'calc(100% - 6px)';
  }

  // -------------------- Ø¢Ù¾Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ± (Ù…Ø´ØªØ±Ú©) --------------------
  headerImageInput.addEventListener('change', function(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      headerImageUrl = event.target.result;
      headerPreview.src = headerImageUrl;
      headerPreview.style.display = 'inline-block';
      const tmp = new Image();
      tmp.onload = () => adaptImageFit(headerPreview);
      tmp.src = headerImageUrl;
    };
    reader.readAsDataURL(file);
  });

  footerImageInput.addEventListener('change', function(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      footerImageUrl = event.target.result;
      footerPreview.src = footerImageUrl;
      footerPreview.style.display = 'inline-block';
      const tmp = new Image();
      tmp.onload = () => adaptImageFit(footerPreview);
      tmp.src = footerImageUrl;
    };
    reader.readAsDataURL(file);
  });

  // -------------------- Ù…Ø±Ø­Ù„Ù‡ 1: Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ùˆ ØªÙˆÙ„ÛŒØ¯ Ø§Ú©Ø³Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø± --------------------
  fileInputStep1.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) { fileInfoStep1.innerText = 'ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡'; return; }
    fileInfoStep1.innerText = `ğŸ“„ ${file.name} (Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù†...)`;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });

        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø·Ø± Ø³Ø±Ø³ØªÙˆÙ† (Ø­Ø§ÙˆÛŒ 'Ø³ÛŒ Ø³ÛŒ', 'Ø§Ù†Ø¬Ù†', 'Ø´Ø§Ø³ÛŒ' Ùˆ 'Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª')
        let headerRowIndex = -1, headers = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!Array.isArray(row)) continue;
          const rowCells = row.map(c => (c || '').toString().trim());
          if (rowCells.some(c => c.includes('Ø³ÛŒ Ø³ÛŒ')) &&
              rowCells.some(c => c.includes('Ø§Ù†Ø¬Ù†')) &&
              rowCells.some(c => c.includes('Ø´Ø§Ø³ÛŒ')) &&
              rowCells.some(c => c.includes('Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª'))) {
            headerRowIndex = i;
            headers = rowCells;
            break;
          }
        }
        if (headerRowIndex === -1) {
          showMessage('âŒ Ø³Ø±Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² (Ø³ÛŒ Ø³ÛŒ, Ø§Ù†Ø¬Ù†, Ø´Ø§Ø³ÛŒ, Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª) ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
          fileInfoStep1.innerText = 'Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§';
          return;
        }

        // Ø°Ø®ÛŒØ±Ù‡ ØªÙ…Ø§Ù… Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ (Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§)
        const dataRows = [];
        for (let r = headerRowIndex + 1; r < rows.length; r++) {
          const row = rows[r];
          if (!Array.isArray(row) || row.length === 0) continue;
          if (row[0] !== undefined && row[0] !== null && row[0].toString().trim() !== '') {
            dataRows.push(row.slice());
          }
        }

        if (dataRows.length === 0) {
          showMessage('âŒ Ù‡ÛŒÚ† Ø±Ø¯ÛŒÙ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
          fileInfoStep1.innerText = 'Û° Ø±Ú©ÙˆØ±Ø¯';
          return;
        }

        step1RawData = { headers, rows: dataRows };
        fileInfoStep1.innerText = `ğŸ“„ ${file.name} | ${dataRows.length} Ø±Ú©ÙˆØ±Ø¯`;
        recordCounter.innerText = `${dataRows.length} Ø±Ø¯ÛŒÙ (Ù…Ø±Ø­Ù„Ù‡ Û±)`;
        showMessage(`âœ… Ù…Ø±Ø­Ù„Ù‡ Û±: ${dataRows.length} Ø±Ú©ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ`, 'success');
      } catch (err) {
        console.error(err);
        showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„: ' + err.message, 'error');
        fileInfoStep1.innerText = 'Ø®Ø·Ø§';
      }
    };
    reader.readAsArrayBuffer(file);
  });

  // ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ Ù…Ø±Ø­Ù„Ù‡ 1
  generateStep1Btn.addEventListener('click', function() {
    if (!step1RawData.rows || step1RawData.rows.length === 0) {
      showMessage('â›” Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ù…Ø¹ØªØ¨Ø± Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Û± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error');
      return;
    }
    const start = parseInt(maktubStart.value, 10);
    if (isNaN(start)) { showMessage('â›” Ø´Ù…Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ù…Ú©ØªÙˆØ¨ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
    const shamsi = dateShamsi.value.trim() || '---';
    const qamari = dateQamari.value.trim() || '---';

    const headers = step1RawData.headers;
    const rows = step1RawData.rows;

    // Ø³Ø§Ø®Øª Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ: Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ + Ø³Ù‡ Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯
    const outputHeaders = [...headers, 'Ù…Ú©ØªÙˆØ¨', 'ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ', 'ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ'];
    const outputRows = [];

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const maktubNumber = start + i;
      const newRow = [...row, maktubNumber, shamsi, qamari];
      outputRows.push(newRow);
    }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([outputHeaders, ...outputRows]);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, 'motor_numbered.xlsx');
    showMessage(`ğŸ“¥ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø¨Ø§ ${rows.length} Ø±Ø¯ÛŒÙ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯`, 'success');
  });

  // -------------------- Ù…Ø±Ø­Ù„Ù‡ 2: Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ù…Ø±Ø­Ù„Ù‡ 1 Ùˆ ØªÙˆÙ„ÛŒØ¯ Ø¨Ø±Ú¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø±Ø¬Ø¹ --------------------
  let step2Data = []; // Ù‡Ø± Ø´ÛŒ Ø´Ø§Ù…Ù„ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ manualMaktub, autoMaktub Ùˆ ...

  fileInputStep2.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) { fileInfoStep2.innerText = 'ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡'; step2Data = []; return; }
    fileInfoStep2.innerText = `ğŸ“„ ${file.name} (Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù†...)`;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
        if (rows.length < 2) { throw new Error('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª'); }

        const headers = rows[0].map(h => (h || '').toString().trim());
        // Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
        const idxMap = {
          serialNo: -1, company: -1, engine: -1, chassis: -1, cc: -1, model: -1,
          province: -1,          // Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª
          manualMaktub: -1,      // Ù†Ù…Ø¨Ø± Ù…Ú©ØªÙˆØ¨ (Ø¯Ø³ØªÛŒ)
          autoMaktub: -1,        // Ù…Ú©ØªÙˆØ¨ (Ø®ÙˆØ¯Ú©Ø§Ø±)
          shamsi: -1, qamari: -1
        };
        headers.forEach((h, idx) => {
          if (h.includes('Ø´Ù…Ø§Ø±Ù‡')) idxMap.serialNo = idx;
          else if (h.includes('Ø§Ø³Ù… Ø´Ø±Ú©Øª')) idxMap.company = idx;
          else if (h.includes('Ø§Ù†Ø¬Ù†')) idxMap.engine = idx;
          else if (h.includes('Ø´Ø§Ø³ÛŒ')) idxMap.chassis = idx;
          else if (h.includes('Ø³ÛŒ Ø³ÛŒ')) idxMap.cc = idx;
          else if (h.includes('Ù…Ø¯Ù„')) idxMap.model = idx;
          else if (h.includes('Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª')) idxMap.province = idx;
          else if (h === 'Ù†Ù…Ø¨Ø± Ù…Ú©ØªÙˆØ¨') idxMap.manualMaktub = idx;  // Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø·Ø§Ø¨Ù‚
          else if (h === 'Ù…Ú©ØªÙˆØ¨') idxMap.autoMaktub = idx;
          else if (h.includes('ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ')) idxMap.shamsi = idx;
          else if (h.includes('ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ')) idxMap.qamari = idx;
        });

        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ
        if (idxMap.serialNo === -1 || idxMap.company === -1 || idxMap.engine === -1 || idxMap.chassis === -1 || idxMap.province === -1 || (idxMap.manualMaktub === -1 && idxMap.autoMaktub === -1)) {
          showMessage('âŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ (Ø´Ù…Ø§Ø±Ù‡, Ø´Ø±Ú©Øª, Ø§Ù†Ø¬Ù†, Ø´Ø§Ø³ÛŒ, Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª, Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ©ÛŒ Ø§Ø² Ù†Ù…Ø¨Ø± Ù…Ú©ØªÙˆØ¨/Ù…Ú©ØªÙˆØ¨) Ø¯Ø± ÙØ§ÛŒÙ„ Ù…Ø±Ø­Ù„Ù‡ Û² ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
          fileInfoStep2.innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„';
          return;
        }

        const dataRows = [];
        for (let r = 1; r < rows.length; r++) {
          const row = rows[r];
          if (!Array.isArray(row) || row.length === 0) continue;
          if (row[idxMap.serialNo] !== undefined && row[idxMap.serialNo] !== null && row[idxMap.serialNo].toString().trim() !== '') {
            const manual = (idxMap.manualMaktub !== -1 && row[idxMap.manualMaktub] !== undefined) ? row[idxMap.manualMaktub].toString().trim() : '';
            const auto = (idxMap.autoMaktub !== -1 && row[idxMap.autoMaktub] !== undefined) ? row[idxMap.autoMaktub].toString().trim() : '';
            dataRows.push({
              serialNo: row[idxMap.serialNo]?.toString().trim() || '',
              company: row[idxMap.company]?.toString().trim() || '',
              engine: row[idxMap.engine]?.toString().trim() || '',
              chassis: row[idxMap.chassis]?.toString().trim() || '',
              cc: idxMap.cc !== -1 ? (row[idxMap.cc]?.toString().trim() || '') : '',
              model: idxMap.model !== -1 ? (row[idxMap.model]?.toString().trim() || '') : '',
              province: row[idxMap.province]?.toString().trim() || '',
              manualMaktub: manual,
              autoMaktub: auto,
              shamsi: idxMap.shamsi !== -1 ? (row[idxMap.shamsi]?.toString().trim() || '') : '',
              qamari: idxMap.qamari !== -1 ? (row[idxMap.qamari]?.toString().trim() || '') : ''
            });
          }
        }
        step2Data = dataRows;
        fileInfoStep2.innerText = `ğŸ“„ ${file.name} | ${step2Data.length} Ø±Ú©ÙˆØ±Ø¯`;
        recordCounter.innerText = `${step2Data.length} Ø±Ø¯ÛŒÙ (Ù…Ø±Ø­Ù„Ù‡ Û²)`;
        showMessage(`âœ… ÙØ§ÛŒÙ„ Ù…Ø±Ø­Ù„Ù‡ Û² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ØŒ ${step2Data.length} Ø±Ú©ÙˆØ±Ø¯`, 'success');
      } catch (err) {
        console.error(err);
        showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ù…Ø±Ø­Ù„Ù‡ Û²: ' + err.message, 'error');
        fileInfoStep2.innerText = 'Ø®Ø·Ø§';
        step2Data = [];
      }
    };
    reader.readAsArrayBuffer(file);
  });

  // ØªØ§Ø¨Ø¹ ØªÙˆÙ„ÛŒØ¯ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø±Ø¬Ø¹ (ÙˆÙ„Ø§ÛŒØª) Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª "Ù†Ù…Ø¨Ø± Ù…Ú©ØªÙˆØ¨" Ø¯Ø³ØªÛŒ
  function generatePagesByProvince() {
    if (step2Data.length === 0) {
      showMessage('â›” Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ Ù…Ø±Ø­Ù„Ù‡ Û² Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯', 'error');
      return;
    }
    let rowsPerPage = parseInt(rowsPerPageInput.value, 10) || 25;
    if (rowsPerPage < 1) rowsPerPage = 25;

    a4Preview.innerHTML = '';

    // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ§Ù† (Ù…Ú©ØªÙˆØ¨ Ø¨Ù‡ ÙˆÙ„Ø§ÛŒØª)
    const groups = {};
    step2Data.forEach(row => {
      const prov = row.province || 'Ù†Ø§Ù…Ø´Ø®Øµ';
      if (!groups[prov]) groups[prov] = [];
      groups[prov].push(row);
    });

    for (const [province, rows] of Object.entries(groups)) {
      if (rows.length === 0) continue;

      const sep = document.createElement('div');
      sep.className = 'province-separator';
      //sep.innerText = `ğŸŒ Ù…Ø±Ø¬Ø¹: ${province} (${rows.length} Ù…ÙˆØªØ±)`;
      a4Preview.appendChild(sep);

      const totalPages = Math.ceil(rows.length / rowsPerPage);
      for (let page = 0; page < totalPages; page++) {
        const start = page * rowsPerPage;
        const end = Math.min(start + rowsPerPage, rows.length);
        const pageRows = rows.slice(start, end);

        const sheet = document.createElement('div'); sheet.className = 'a4-paper';

        // Ø³Ø±Ø¨Ø±Ú¯
        const headerDiv = document.createElement('div'); headerDiv.className = 'header-container';
        if (headerImageUrl) {
          const img = document.createElement('img');
          img.className = 'sheet-header-img';
          img.src = headerImageUrl;
          img.addEventListener('load', () => adaptImageFit(img), { once: true });
          headerDiv.appendChild(img);
        } else {
          headerDiv.innerText = ' [ Ø³Ø±Ø¨Ø±Ú¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ ] ';
          headerDiv.style.color = '#777';
          headerDiv.style.display = 'flex'; headerDiv.style.alignItems = 'center'; headerDiv.style.justifyContent = 'center';
        }
        sheet.appendChild(headerDiv);

        // Ø¬Ø¯ÙˆÙ„ â€” Ø¹Ù†ÙˆØ§Ù† Ø³ØªÙˆÙ† Ù‡Ø´ØªÙ… "Ù…Ø±Ø¬Ø¹" Ø§Ø³ØªØŒ Ø³ØªÙˆÙ† Ù†Ù‡Ù… "Ù…Ú©ØªÙˆØ¨" (ØªØ±Ú©ÛŒØ¨ÛŒ)
        const tableContainer = document.createElement('div'); tableContainer.className = 'table-container';
        let tableHtml = `<table class="motor-table" dir="rtl"><thead><tr>
          <th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ù†Ø§Ù… Ø´Ø±Ú©Øª</th><th>Ù†Ø§Ù… Ø³ÛŒÚ©Ù„</th><th>Ø§Ù†Ø¬ÛŒÙ†</th><th>Ø´Ø§Ø³ÛŒ</th>
          <th>Ø³ÛŒ Ø³ÛŒ</th><th>Ù…Ø¯Ù„</th><th>Ù…Ø±Ø¬Ø¹</th><th>Ù…Ú©ØªÙˆØ¨</th><th>ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ</th><th>ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ</th>
        </tr></thead><tbody>`;

        pageRows.forEach(r => {
          // ØªØ¹ÛŒÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù…Ú©ØªÙˆØ¨ Ù†Ù‡Ø§ÛŒÛŒ: Ø§Ú¯Ø± manualMaktub ØºÛŒØ± Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ†ØµÙˆØ±Øª autoMaktub
          let finalMaktub = r.manualMaktub && r.manualMaktub !== '' ? r.manualMaktub : r.autoMaktub;
          if (finalMaktub === undefined) finalMaktub = ''; // Ø§ÛŒÙ…Ù†ÛŒ

          const esc = s => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
          tableHtml += `<tr>
            <td title="${esc(r.serialNo)}">${esc(r.serialNo)}</td>
            <td title="${esc(r.company)}">${esc(r.company)}</td>
            <td title="BAJAJ">BAJAJ</td>
            <td title="${esc(r.engine)}">${esc(r.engine)}</td>
            <td title="${esc(r.chassis)}">${esc(r.chassis)}</td>
            <td title="${esc(r.cc)}">${esc(r.cc)}</td>
            <td title="${esc(r.model)}">${esc(r.model)}</td>
            <td title="${esc(r.province)}">${esc(r.province)}</td>
            <td title="${esc(finalMaktub)}">${esc(finalMaktub)}</td>
            <td title="${esc(r.shamsi)}">${esc(r.shamsi)}</td>
            <td title="${esc(r.qamari)}">${esc(r.qamari)}</td>
          </tr>`;
        });
        tableHtml += '</tbody></table>';
        tableContainer.innerHTML = tableHtml;
        sheet.appendChild(tableContainer);

        // Ù¾Ø§ÙˆØ±Ù‚ÛŒ
        const footerDiv = document.createElement('div'); footerDiv.className = 'footer-container';
        if (footerImageUrl) {
          const img = document.createElement('img');
          img.className = 'sheet-footer-img';
          img.src = footerImageUrl;
          img.addEventListener('load', () => adaptImageFit(img), { once: true });
          footerDiv.appendChild(img);
        } else {
          footerDiv.innerText = ' [ Ù¾Ø§ÙˆØ±Ù‚ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ ] ';
          footerDiv.style.color = '#777';
          footerDiv.style.display = 'flex'; footerDiv.style.alignItems = 'center'; footerDiv.style.justifyContent = 'center';
        }
        sheet.appendChild(footerDiv);

        a4Preview.appendChild(sheet);
      }
    }
    showMessage(`âœ… Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø±Ø¬Ø¹ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯ (Ù…Ø¬Ù…ÙˆØ¹ ${step2Data.length} Ø±Ú©ÙˆØ±Ø¯)`, 'success');
  }

  generateStep2Btn.addEventListener('click', generatePagesByProvince);

  // Ú†Ø§Ù¾
  printBtn.addEventListener('click', () => {
    if (a4Preview.children.length === 0) { showMessage('â›” Ø§Ø¨ØªØ¯Ø§ Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Û² ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
    window.print();
  });

  showMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ø±Ø­Ù„Ù‡ Û±: ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø§Ú©Ø³Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯. Ø³Ù¾Ø³ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ "Ù†Ù…Ø¨Ø± Ù…Ú©ØªÙˆØ¨" Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø§ÛŒÛŒØ¯.', 'info', 6000);
})();
</script>
</body>
</html>
